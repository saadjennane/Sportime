name: Weekly XP Calculation
on:
  schedule:
    # Runs every Monday at 00:00 UTC
    - cron: '0 0 * * 1'

  # Allows manual trigger from GitHub Actions tab
  workflow_dispatch:

jobs:
  calculate-weekly-xp:
    runs-on: ubuntu-latest

    steps:
      - name: Calculate Weekly XP for All Users
        run: |
          echo "üéØ Calculating weekly XP for all users..."

          RESPONSE=$(curl -X POST \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            -w "\n%{http_code}" \
            ${{ secrets.SUPABASE_URL }}/functions/v1/calculate-weekly-xp)

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Response: $BODY"

          if [ $HTTP_CODE -eq 200 ]; then
            echo "‚úÖ Weekly XP calculation completed successfully"
            echo "$BODY" | jq '.'
          else
            echo "‚ùå Weekly XP calculation failed with status $HTTP_CODE"
            echo "$BODY"
            exit 1
          fi

      - name: Check and Award Badges
        if: success()
        run: |
          echo "üèÜ Checking badge eligibility for all users..."

          RESPONSE=$(curl -X POST \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            -w "\n%{http_code}" \
            ${{ secrets.SUPABASE_URL }}/functions/v1/check-badge-awards)

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Response: $BODY"

          if [ $HTTP_CODE -eq 200 ]; then
            echo "‚úÖ Badge check completed successfully"
            echo "$BODY" | jq '.'
          else
            echo "‚ùå Badge check failed with status $HTTP_CODE"
            echo "$BODY"
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "üìä Weekly XP Calculation Summary"
          echo "================================"
          echo "Timestamp: $(date -u)"
          echo "Status: ${{ job.status }}"
